<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR-Quiz ‚Äî Gerar e Ler</title>
<style>
  body { font-family: Arial; background:#0b0c10; color:#e7e9ee; text-align:center; padding:20px; }
  button { padding:10px 20px; margin:5px; border:none; border-radius:8px; cursor:pointer; }
  button.primary { background:#2a9d8f; color:#fff; }
  button.ghost { background:#111; color:#e7e9ee; border:1px solid #2a9d8f; }
  input { padding:6px 10px; border-radius:6px; border:1px solid #444; }
  #qrOut img, #qrOut canvas { width:200px; height:200px; margin-top:10px; }
  video { width:300px; height:300px; border-radius:12px; background:#000; margin-top:10px; }
  #answer { font-size: 40px; font-weight:bold; margin-top:10px; color:#7cd992; }
</style>
</head>
<body>

<h1>QR-Quiz ‚Äî Gerar e Ler</h1>

<div>
  <h3>Gerar QR Code</h3>
  <input id="qrText" type="text" placeholder="Texto do QR" value="QUIZ">
  <button id="genQr" class="primary">Gerar QR</button>
  <button id="dlQr" class="ghost" disabled>Baixar</button>
  <div id="qrOut"></div>
</div>

<hr style="margin:30px 0; border-color:#444;">

<div>
  <h3>Ler QR Code e detectar alternativa</h3>
  <button id="startBtn" class="primary">üì∑ Abrir c√¢mera</button>
  <button id="stopBtn" class="ghost" disabled>‚èπ Parar</button>
  <video id="video" playsinline muted></video>
  <canvas id="canvas" style="display:none;"></canvas>
  <div id="answer">‚Äî</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<script>
  // =========================
  // Gerador QR
  // =========================
  const qrOut = document.getElementById('qrOut');
  let qrInstance = null;

  document.getElementById('genQr').addEventListener('click', ()=>{
    qrOut.innerHTML = '';
    qrInstance = new QRCode(qrOut, {
      text: document.getElementById('qrText').value || 'QUIZ',
      width: 200,
      height: 200,
      correctLevel: QRCode.CorrectLevel.H
    });
    document.getElementById('dlQr').disabled = false;
  });

  document.getElementById('dlQr').addEventListener('click', ()=>{
    const img = qrOut.querySelector('img') || qrOut.querySelector('canvas');
    const link = document.createElement('a');
    if(img.tagName === 'IMG') link.href = img.src;
    else link.href = img.toDataURL();
    link.download = 'qr.png';
    link.click();
  });

  // =========================
  // Leitor QR + Alternativa
  // =========================
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const answerEl = document.getElementById('answer');

  let stream = null;
  let rafId = null;
  const history = [];
  const HISTORY_N = 12;
  let confirmed = null;

  function angleFromCorners(c){
    const dx = c.topRightCorner.x - c.topLeftCorner.x;
    const dy = c.topRightCorner.y - c.topLeftCorner.y;
    let deg = Math.atan2(dy, dx) * 180/Math.PI;
    if(deg<0) deg+=360;
    return deg;
  }

  function mapAngleToAnswer(deg){
    const idx = Math.round(deg/90)%4;
    return ['A','B','C','D'][idx];
  }

  function mostCommon(arr){
    const m = new Map();
    for(const v of arr) m.set(v,(m.get(v)||0)+1);
    let best=null, bestN=0;
    m.forEach((n,k)=>{ if(n>bestN){best=k;bestN=n;} });
    return best;
  }

  function confidence(arr,val){
    if(!val) return 0;
    const n = arr.filter(x=>x===val).length;
    return n/arr.length;
  }

  function scan(){
    if(!stream) return;
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video,0,0,canvas.width,canvas.height);

    try{
      const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
      const code = jsQR(imgData.data,imgData.width,imgData.height);
      if(code && code.location){
        const deg = angleFromCorners(code.location);
        const ans = mapAngleToAnswer(deg);
        history.push(ans);
        if(history.length>HISTORY_N) history.shift();
        const stable = mostCommon(history);
        if(confidence(history,stable)>=0.6 && stable!==confirmed){
          confirmed = stable;
          answerEl.textContent = confirmed;
        }
      } else {
        history.length = 0;
        answerEl.textContent = '‚Äî';
      }
    }catch(e){}
    rafId = requestAnimationFrame(scan);
  }

  async function startCamera(){
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    video.srcObject = stream;
    await video.play();
    startBtn.disabled = true;
    stopBtn.disabled = false;
    scan();
  }

  function stopCamera(){
    if(stream) stream.getTracks().forEach(t=>t.stop());
    stream=null;
    startBtn.disabled=false;
    stopBtn.disabled=true;
    cancelAnimationFrame(rafId);
    answerEl.textContent='‚Äî';
    history.length=0;
    confirmed=null;
  }

  startBtn.addEventListener('click', startCamera);
  stopBtn.addEventListener('click', stopCamera);
</script>

</body>
</html>
