<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Quiz Dinâmico</title>
<style>
:root {
  --bg:#0b0c10; --card:#111318; --muted:#9aa1ac; --text:#e7e9ee; --accent:#7cd992;
}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text);}
.wrap{max-width:1200px;margin:0 auto;padding:20px;}
.card{background:var(--card);border-radius:12px;padding:16px;margin-bottom:16px;}
input,button,select{padding:6px 10px;margin:4px 0;border-radius:6px;border:1px solid #2a2f3a;background:#0f1116;color:var(--text);}
button{cursor:pointer;}
button.primary{background:linear-gradient(180deg,#2a9d8f,#238b7f);border:0;color:#fff;}
.grid{display:grid;gap:16px;}
video{width:100%;max-height:300px;background:#000;border-radius:12px;}
canvas{display:none;}
ul{padding-left:16px;}
.answer{font-weight:bold;color:var(--accent);}
</style>
</head>
<body>
<div class="wrap">

  <h1>QR Quiz Dinâmico</h1>

  <!-- Cadastro de Turmas -->
  <div class="card">
    <h3>Cadastro de Turma</h3>
    <input type="text" id="turmaName" placeholder="Nome da turma">
    <button id="addTurma" class="primary">Adicionar Turma</button>
    <div id="turmasList"></div>
  </div>

  <!-- Cadastro de Alunos -->
  <div class="card">
    <h3>Cadastro de Alunos</h3>
    <label>Turma:
      <select id="turmaSelect"></select>
    </label><br>
    <input type="text" id="alunoName" placeholder="Nome do aluno">
    <button id="addAluno" class="primary">Adicionar Aluno</button>
    <div id="alunosList"></div>
  </div>

  <!-- Gerar QR -->
  <div class="card">
    <h3>Gerar QR do Aluno</h3>
    <label>Escolha o aluno:
      <select id="alunoSelect"></select>
    </label>
    <button id="genQr" class="primary">Gerar QR</button>
    <div id="qrOut"></div>
  </div>

  <!-- Leitura QR -->
  <div class="card">
    <h3>Leitura do QR Code</h3>
    <video id="video" autoplay muted playsinline></video>
    <div>
      Alternativa detectada: <span id="answer" class="answer">—</span>
    </div>
    <button id="resetAnswer">Refazer Escolha</button>
  </div>

  <!-- Alunos e respostas -->
  <div class="card">
    <h3>Respostas dos Alunos</h3>
    <div id="respostas"></div>
  </div>

</div>

<!-- Bibliotecas -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<script>
// =======================
// Estrutura de dados
// =======================
let data = JSON.parse(localStorage.getItem('qrquizData')) || { turmas: [] };

// =======================
// Utilitários
// =======================
function saveData(){ localStorage.setItem('qrquizData', JSON.stringify(data)); }
function updateTurmas(){
  const turmaSelect = document.getElementById('turmaSelect');
  turmaSelect.innerHTML = data.turmas.map((t,i)=>`<option value="${i}">${t.nome}</option>`).join('');
  document.getElementById('turmasList').innerHTML = data.turmas.map(t=>`<div>${t.nome}</div>`).join('');
  updateAlunos();
}
function updateAlunos(){
  const turmaIndex = document.getElementById('turmaSelect').value;
  const alunoSelect = document.getElementById('alunoSelect');
  alunoSelect.innerHTML = '';
  document.getElementById('alunosList').innerHTML = '';
  if(turmaIndex===null || turmaIndex===undefined) return;
  const turma = data.turmas[turmaIndex];
  turma.alunos = turma.alunos || [];
  turma.alunos.forEach((a,i)=>{
    alunoSelect.innerHTML += `<option value="${i}">${a.nome}</option>`;
    document.getElementById('alunosList').innerHTML += `<div>${a.nome} - QR: ${a.qr || '—'} - Resposta: ${a.resposta || '—'}</div>`;
  });
  updateRespostas();
}
function updateRespostas(){
  const resDiv = document.getElementById('respostas');
  resDiv.innerHTML = '';
  data.turmas.forEach(t=>{
    if(!t.alunos) return;
    t.alunos.forEach(a=>{
      resDiv.innerHTML += `<div>${a.nome} (${t.nome}) - Resposta: ${a.resposta || '—'}</div>`;
    });
  });
}

// =======================
// Eventos Cadastro
// =======================
document.getElementById('addTurma').addEventListener('click',()=>{
  const nome = document.getElementById('turmaName').value.trim();
  if(!nome) return alert('Digite nome da turma');
  data.turmas.push({nome, alunos:[]});
  saveData(); updateTurmas();
  document.getElementById('turmaName').value='';
});

document.getElementById('addAluno').addEventListener('click',()=>{
  const alunoNome = document.getElementById('alunoName').value.trim();
  const turmaIndex = document.getElementById('turmaSelect').value;
  if(!alunoNome) return alert('Digite nome do aluno');
  if(turmaIndex===null) return alert('Selecione turma');
  data.turmas[turmaIndex].alunos.push({nome:alunoNome});
  saveData(); updateAlunos();
  document.getElementById('alunoName').value='';
});

// =======================
// Gerar QR
// =======================
let qrInstance = null;
document.getElementById('genQr').addEventListener('click',()=>{
  const turmaIndex = document.getElementById('turmaSelect').value;
  const alunoIndex = document.getElementById('alunoSelect').value;
  if(turmaIndex===null || alunoIndex===null) return alert('Selecione aluno');
  const aluno = data.turmas[turmaIndex].alunos[alunoIndex];
  // Conteúdo do QR = nome do aluno
  const qrOut = document.getElementById('qrOut');
  qrOut.innerHTML='';
  qrInstance = new QRCode(qrOut,{ text: aluno.nome, width: 200, height: 200, correctLevel: QRCode.CorrectLevel.H });
  aluno.qr = aluno.nome;
  saveData();
  updateAlunos();
});
try {
  const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const code = jsQR(img.data, img.width, img.height, { inversionAttempts: 'dontInvert' });

  if (code && code.location && code.data) {
    const alunoNome = code.data; // o texto do QR (ex.: "Leonardo")
    
    // buscar o aluno no cadastro
    let alunoObj = null;
    data.turmas.forEach(t => {
      t.alunos.forEach(a => {
        if (a.nome === alunoNome) alunoObj = a;
      });
    });

    if (alunoObj) {
      // cálculo do ângulo correto
      const loc = code.location;
      const dx = loc.topRightCorner.x - loc.topLeftCorner.x;
      const dy = loc.topRightCorner.y - loc.topLeftCorner.y;
      let deg = Math.atan2(dy, dx) * 180 / Math.PI; // [-180,180]
      if (deg < 0) deg += 360; // [0,360)

      // mapear ângulo para A/B/C/D
      const idx = Math.round(deg / 90) % 4;
      const alternativa = ['A', 'B', 'C', 'D'][idx];

      // registrar resposta do aluno
      alunoObj.resposta = alternativa;
      answerEl.textContent = `${alunoObj.nome} → ${alternativa}`;

      saveData();
      updateRespostas();
    }

    // desenhar contorno verde
    drawCorners(code.location, true);
    angleRead.textContent = `${deg.toFixed(0)}°`;

  } else {
    drawNoCode();
  }
} catch(e){ /* ignorar erros de frame */ }


// =======================
// Leitura QR
// =======================
const video = document.getElementById('video');
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');
let stream = null;
let answerEl = document.getElementById('answer');

async function startCamera(){
  if(!navigator.mediaDevices.getUserMedia) return alert('Sem getUserMedia');
  stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }});
  video.srcObject = stream;
  requestAnimationFrame(scan);
}
startCamera();

function scan(){
  if(video.readyState===video.HAVE_ENOUGH_DATA){
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
    const code = jsQR(imgData.data,imgData.width,imgData.height,{inversionAttempts:'dontInvert'});
    if(code && code.data){
      const alunoNome = code.data;
      // achar aluno cadastrado
      let alunoObj = null;
      data.turmas.forEach(t=>{
        t.alunos.forEach(a=>{
          if(a.nome===alunoNome) alunoObj = a;
        });
      });
      if(alunoObj){
        // Determinar alternativa pela posição
        const loc = code.location;
        const dx = loc.topRightCorner.x - loc.topLeftCorner.x;
        const dy = loc.topRightCorner.y - loc.topLeftCorner.y;
        let deg = Math.atan2(dy,dx)*180/Math.PI;
        if(deg<0) deg+=360;
        const idx = Math.round(deg/90)%4;
        const alternativa = ['A','B','C','D'][idx];
        alunoObj.resposta = alternativa;
        answerEl.textContent = `${alunoObj.nome} → ${alternativa}`;
        saveData();
        updateRespostas();
      }
    }
  }
  requestAnimationFrame(scan);
}

// =======================
// Refazer escolha
// =======================
document.getElementById('resetAnswer').addEventListener('click',()=>{
  data.turmas.forEach(t=>{
    t.alunos.forEach(a=>{
      if(a.resposta) a.resposta = null;
    });
  });
  answerEl.textContent='—';
  saveData();
  updateRespostas();
});

updateTurmas();
</script>
</body>
</html>
