<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>QR-Quiz ‚Äî Leitor por orienta√ß√£o (A/B/C/D)</title>
<style>
:root { --bg:#0b0c10; --card:#111318; --muted:#9aa1ac; --text:#e7e9ee; --accent:#7cd992; }
*{box-sizing:border-box}
body{margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial; background:var(--bg); color:var(--text)}
.wrap{max-width:1100px; margin:0 auto; padding:20px;}
.grid{display:grid; gap:16px}
.card{background:var(--card); border:1px solid #20232a; border-radius:16px; padding:16px; box-shadow: 0 10px 30px rgba(0,0,0,.35)}
h1{font-size: clamp(20px, 2.6vw, 34px); margin:0 0 6px}
.sub{color:var(--muted); margin:0 0 16px}
.row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
label{font-size:14px; color:var(--muted)}
input[type="text"], select, button{height:40px; border-radius:10px; border:1px solid #2a2f3a; background:#0f1116; color:var(--text); padding:0 12px;}
input[type="text"]{min-width:220px}
button{cursor:pointer}
button.primary{background:linear-gradient(180deg,#2a9d8f,#238b7f); border:0}
button.ghost{background:#0f1116}
button:disabled{opacity:.5; cursor:not-allowed}
.pill{background:#131721; border:1px solid #252a35; border-radius:999px; padding:4px 10px; font-size:12px; color:var(--muted)}
.muted{color:var(--muted)}
.success{color:var(--accent)}

.panels{display:grid; grid-template-columns: 1.1fr .9fr; gap:16px}
@media (max-width: 900px){ .panels{grid-template-columns:1fr} }

.video-wrap{position:relative; display:grid; gap:10px}
video{width:100%; max-height:54vh; background:#000; border-radius:14px}
canvas{position:absolute; inset:0; width:100%; max-height:54vh; border-radius:14px; pointer-events:none;}

.badge{display:inline-flex; align-items:center; gap:6px; font-size:13px; padding:6px 10px; border-radius:999px; background:#141823; border:1px solid #273047;}
.answer{font-size: clamp(42px, 8vw, 84px); font-weight: 900; letter-spacing:.02em;}

.qr-box{display:flex; flex-direction:column; gap:12px; align-items:flex-start}
#qrOut{background: #fff; padding:14px; border-radius:12px}
#qrOut canvas, #qrOut img{width:240px; height:240px}

.foot{margin-top:6px; font-size:12px; color:var(--muted)}
</style>
</head>
<body>
<div class="wrap grid">
<header>
  <h1>QR-Quiz ‚Äî Responda elevando o QR</h1>
  <p class="sub">Gire o QR no ar para escolher <strong>A / B / C / D</strong>. O leitor detecta a <em>orienta√ß√£o</em> do QR via c√¢mera.</p>
  <div class="row">
    <span class="pill">Dica: imprima 1 QR por aluno; o conte√∫do pode ser apenas "QUIZ" ou um ID, como "Aluno-23".</span>
  </div>
</header>

<section class="panels">
  <div class="card video-wrap">
    <div class="row">
      <button id="startBtn" class="primary">üì∑ Iniciar c√¢mera</button>
      <button id="stopBtn" class="ghost" disabled>‚èπ Parar</button>
      <label class="row"><input type="checkbox" id="mirrorToggle"> espelhar</label>
      <label>c√¢mera: <select id="camSelect"></select></label>
      <span id="status" class="badge">Pronto</span>
    </div>

    <video id="video" playsinline muted></video>
    <canvas id="canvas" aria-hidden="true"></canvas>

    <div class="row" style="justify-content:space-between">
      <div>
        <div class="muted">Alternativa detectada</div>
        <div id="answer" class="answer">‚Äî</div>
      </div>
      <div>
        <div class="muted">√Çngulo</div>
        <div id="angleRead" class="badge">‚Äî</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>Gerar seu QR para imprimir</h3>
    <div class="qr-box">
      <div class="row">
        <input id="qrText" type="text" placeholder="Texto do QR (ex.: QUIZ ou Aluno-23)" value="QUIZ"/>
        <button id="genQr" class="primary">Gerar</button>
        <button id="dlQr" class="ghost" disabled>Baixar PNG</button>
        <button id="printQr" class="ghost" disabled>Imprimir</button>
      </div>
      <div id="qrOut"></div>
      <div class="foot">O leitor ignora o conte√∫do. Apenas a <strong>rota√ß√£o</strong> define A/B/C/D:
        <br>0¬∞‚ÜíA &nbsp; 90¬∞‚ÜíB &nbsp; 180¬∞‚ÜíC &nbsp; 270¬∞‚ÜíD
      </div>
    </div>
  </div>
</section>

<section class="card">
  <h3>Como funciona</h3>
  <ol>
    <li>Clique em <strong>Iniciar c√¢mera</strong> e permita o acesso. Se dispon√≠vel, escolha a c√¢mera <em>traseira</em>.</li>
    <li>Mostre o QR para a c√¢mera. O contorno ficar√° verde quando for detectado.</li>
    <li>A orienta√ß√£o (√¢ngulo) √© mapeada para A/B/C/D. Segure por 0,4s para confirmar (evita tremidas).</li>
    <li>Use <em>espelhar</em> se estiver usando c√¢mera frontal e a detec√ß√£o parecer invertida.</li>
  </ol>
  <p class="foot">Sirva a p√°gina via <code>https</code> ou servidor local (VSCode Live Server, <code>python -m http.server</code>).</p>
</section>
</div>

<!-- Bibliotecas -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<script>
// ==========================
// Utilit√°rios
// ==========================
const $ = (s)=>document.querySelector(s);
function setStatus(msg,ok){const el=$('#status'); el.textContent=msg; el.style.borderColor=ok?'#2a9d8f':'#273047';}
function beep(){try{const ac=new (window.AudioContext||window.webkitAudioContext)();const o=ac.createOscillator();const g=ac.createGain();o.type='sine';o.frequency.value=880;o.connect(g); g.connect(ac.destination); g.gain.setValueAtTime(0.0001,ac.currentTime); g.gain.exponentialRampToValueAtTime(0.3,ac.currentTime+0.01); o.start(); o.stop(ac.currentTime+0.12);}catch(e){}}
function angleFromCorners(c){const dx=c.topRightCorner.x-c.topLeftCorner.x; const dy=c.topRightCorner.y-c.topLeftCorner.y; let deg=Math.atan2(dy,dx)*180/Math.PI; if(deg<0) deg+=360; return deg;}
function mapAngleToAnswer(deg){const idx=(Math.round(deg/90)%4+4)%4; return ['A','B','C','D'][idx];}
function mostCommon(arr){const m=new Map(); for(const v of arr){m.set(v,(m.get(v)||0)+1);} let best=null,bestN=0; m.forEach((n,k)=>{if(n>bestN){best=k; bestN=n;}}); return best;}
function confidence(arr,val){if(!val)return 0; const n=arr.filter(x=>x===val).length; return n/arr.length;}

// ==========================
// C√¢mera + Leitura
// ==========================
const video=$('#video'), canvas=$('#canvas'), ctx=canvas.getContext('2d');
const startBtn=$('#startBtn'), stopBtn=$('#stopBtn'), camSelect=$('#camSelect'), mirrorToggle=$('#mirrorToggle');
const answerEl=$('#answer'), angleRead=$('#angleRead');
let stream=null, rafId=null, running=false, confirmed=null;
const history=[], HISTORY_N=12;

async function listCameras(){
  try{
    const devices=await navigator.mediaDevices.enumerateDevices();
    const cams=devices.filter(d=>d.kind==='videoinput');
    camSelect.innerHTML=cams.map((c,i)=>`<option value="${c.deviceId}">${c.label||'C√¢mera '+(i+1)}</option>`).join('');
  }catch(e){}
}

async function startCamera(){
  if(!navigator.mediaDevices?.getUserMedia){ setStatus('Navegador sem getUserMedia', false); return; }
  stopCamera(); setStatus('Abrindo c√¢mera...', true);
  const deviceId = camSelect.value||undefined;
  try{
    stream = await navigator.mediaDevices.getUserMedia(deviceId?{video:{deviceId:{exact:deviceId}}}:{video:{facingMode:{ideal:'environment'}}});
    video.srcObject = stream;
    await video.play();
    startBtn.disabled=true; stopBtn.disabled=false;
    video.addEventListener('loadedmetadata', ()=>{
      canvas.width=video.videoWidth; canvas.height=video.videoHeight;
      running=true; scanLoop();
    });
    listCameras();
    setStatus('C√¢mera ativa', true);
  }catch(e){ console.error(e); setStatus('Falha ao abrir c√¢mera', false); }
}

function stopCamera(){running=false; startBtn.disabled=false; stopBtn.disabled=true; if(rafId) cancelAnimationFrame(rafId); if(stream){stream.getTracks().forEach(t=>t.stop()); stream=null;} setStatus('Parado', false); confirmed=null; answerEl.textContent='‚Äî'; angleRead.textContent='‚Äî';}

function drawCorners(corners,ok){ctx.lineWidth=4; ctx.strokeStyle=ok?'#3ad07a':'#e55353'; ctx.beginPath(); ctx.moveTo(corners.topLeftCorner.x,corners.topLeftCorner.y); ctx.lineTo(corners.topRightCorner.x,corners.topRightCorner.y); ctx.lineTo(corners.bottomRightCorner.x,corners.bottomRightCorner.y); ctx.lineTo(corners.bottomLeftCorner.x,corners.bottomLeftCorner.y); ctx.closePath(); ctx.stroke();}
function drawNoCode(){angleRead.textContent='‚Äî'; ctx.lineWidth=3; ctx.strokeStyle='#5d6474'; const m=Math.min(canvas.width,canvas.height); ctx.strokeRect((canvas.width-m)/2+0.5,(canvas.height-m)/2+0.5,m-1,m-1);}

function scanLoop(){
  if(!running) return;
  ctx.save();
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(mirrorToggle.checked){ctx.translate(canvas.width,0); ctx.scale(-1,1);}
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  ctx.restore();
  try{
    const img=ctx.getImageData(0,0,canvas.width,canvas.height);
    const code=jsQR(img.data,img.width,img.height,{inversionAttempts:'attemptBoth'});
    if(code && code.location){
      const deg=angleFromCorners(code.location);
      const ans=mapAngleToAnswer(deg);
      angleRead.textContent=`${deg.toFixed(0)}¬∞`;
      drawCorners(code.location,true);
      history.push(ans); if(history.length>HISTORY_N) history.shift();
      const stable=mostCommon(history);
      if(confidence(history,stable)>=0.6 && stable!==confirmed){
        confirmed=stable; answerEl.textContent=confirmed; beep();
        if(navigator.vibrate) navigator.vibrate(60);
      }
    }else{ drawNoCode(); history.length=0; confirmed=null; answerEl.textContent='‚Äî';}
  }catch(e){console.log(e);}
  rafId=requestAnimationFrame(scanLoop);
}

startBtn.addEventListener('click', startCamera);
stopBtn.addEventListener('click', stopCamera);
if(navigator.mediaDevices?.enumerateDevices) listCameras();

// ==========================
// Gerador QR
// ==========================
const qrText=$('#qrText'), genQr=$('#genQr'), dlQr=$('#dlQr'), printQr=$('#printQr'), qrOut=$('#qrOut');
let qrInstance=null;
function generateQR(){qrOut.innerHTML=''; qrInstance=new QRCode(qrOut,{text:qrText.value||'QUIZ',width:240,height:240,correctLevel:QRCode.CorrectLevel.H}); dlQr.disabled=false; printQr.disabled=false;}
function downloadQR(){const img=qrOut.querySelector('img')||qrOut.querySelector('canvas'); if(!img) return; let dataURL=img.tagName.toLowerCase()==='img'?img.src:img.toDataURL('image/png'); const a=document.createElement('a'); a.href=dataURL; a.download=`qr-${(qrText.value||'quiz').toLowerCase()}.png`; a.click();}
function printQR(){const w=window.open('','printqr'); const src=(qrOut.querySelector('img')?.src)||(qrOut.querySelector('canvas')?.toDataURL('image/png')); w.document.write(`<img src="${src}" style="width:380px;height:380px"/>`); w.document.close(); w.focus(); w.print(); w.close();}

genQr.addEventListener('click', generateQR);
dlQr.addEventListener('click', downloadQR);
printQr.addEventListener('click', printQR);

// gerar padr√£o inicial
generateQR();
</script>
</body>
</html>
