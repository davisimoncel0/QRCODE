<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR-Quiz ‚Äî Registrar Alternativa por lado</title>
<style>
  :root{--bg:#0b0c10;--card:#111318;--muted:#9aa1ac;--text:#e7e9ee;--accent:#7cd992}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,sans-serif;background:var(--bg);color:var(--text);}
  .wrap{max-width:900px;margin:0 auto;padding:20px;}
  .card{background:var(--card);border-radius:16px;padding:16px;margin-bottom:16px;}
  button{cursor:pointer;padding:8px 12px;border-radius:10px;border:none;background:#238b7f;color:#fff;}
  video, canvas{width:100%;max-height:400px;border-radius:12px;background:#000;}
  #answer{font-size:2rem;font-weight:bold;margin-top:10px;}
  #log{margin-top:10px;background:#141823;padding:10px;border-radius:12px;max-height:200px;overflow:auto;}
</style>
</head>
<body>
<div class="wrap">
  <h1>QR-Quiz ‚Äî Levante o lado correto</h1>

  <div class="card">
    <button id="startBtn">üì∑ Iniciar c√¢mera</button>
    <button id="stopBtn" disabled>‚èπ Parar</button>
    <video id="video" autoplay muted playsinline></video>
    <canvas id="canvas"></canvas>
    <div>Alternativa detectada: <span id="answer">‚Äî</span></div>
    <div id="log"></div>
  </div>

  <div class="card">
    <h3>Gerar QR code</h3>
    <input id="qrText" type="text" value="QUIZ">
    <button id="genQr">Gerar QR</button>
    <div id="qrOut"></div>
    <p>Lados do QR:</p>
    <ul>
      <li>Topo esquerdo ‚Üí A</li>
      <li>Topo direito ‚Üí B</li>
      <li>Inferior direito ‚Üí C</li>
      <li>Inferior esquerdo ‚Üí D</li>
    </ul>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const answerEl = document.getElementById('answer');
const logEl = document.getElementById('log');
let stream=null, rafId=null;
let lastDetected=null;

startBtn.onclick = async () => {
  try {
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    video.srcObject = stream;
    await video.play();
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    startBtn.disabled = true;
    stopBtn.disabled = false;
    scanLoop();
  } catch(e){
    alert('N√£o foi poss√≠vel acessar a c√¢mera.');
  }
};

stopBtn.onclick = () => {
  if(stream) stream.getTracks().forEach(t=>t.stop());
  startBtn.disabled = false;
  stopBtn.disabled = true;
  cancelAnimationFrame(rafId);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  answerEl.textContent = '‚Äî';
};

// Fun√ß√£o para detectar lado do QR
function detectSide(code){
  const corners = [
    {corner:'A',pt:code.location.topLeftCorner},
    {corner:'B',pt:code.location.topRightCorner},
    {corner:'C',pt:code.location.bottomRightCorner},
    {corner:'D',pt:code.location.bottomLeftCorner}
  ];
  // Escolher o ponto mais pr√≥ximo do topo (y menor)
  const topMost = corners.reduce((prev,curr)=>curr.pt.y<prev.pt.y?curr:prev);
  return topMost.corner;
}

function scanLoop(){
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
  const code = jsQR(imgData.data,imgData.width,imgData.height);
  if(code && code.location){
    // Desenhar contorno
    ctx.strokeStyle = '#00FF00';
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(code.location.topLeftCorner.x, code.location.topLeftCorner.y);
    ctx.lineTo(code.location.topRightCorner.x, code.location.topRightCorner.y);
    ctx.lineTo(code.location.bottomRightCorner.x, code.location.bottomRightCorner.y);
    ctx.lineTo(code.location.bottomLeftCorner.x, code.location.bottomLeftCorner.y);
    ctx.closePath();
    ctx.stroke();

    const side = detectSide(code);
    answerEl.textContent = side;

    // Registrar nova detec√ß√£o (evita repeti√ß√£o imediata)
    if(side!==lastDetected){
      lastDetected=side;
      const div = document.createElement('div');
      div.textContent = `Alternativa escolhida: ${side}`;
      logEl.prepend(div);
    }

  } else {
    answerEl.textContent = '‚Äî';
  }
  rafId = requestAnimationFrame(scanLoop);
}

// ==================== QR Code ====================
const qrOut = document.getElementById('qrOut');
document.getElementById('genQr').onclick = ()=>{
  qrOut.innerHTML='';
  new QRCode(qrOut,{text:document.getElementById('qrText').value,width:240,height:240,correctLevel:QRCode.CorrectLevel.H});
};
</script>
</body>
</html>
