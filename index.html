<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Quiz Completo</title>
<style>
:root { --bg:#0b0c10; --card:#111318; --muted:#9aa1ac; --text:#e7e9ee; --accent:#7cd992; }
body{margin:0; font-family: system-ui, sans-serif; background:var(--bg); color:var(--text);}
.wrap{max-width:1100px; margin:0 auto; padding:20px;}
.card{background:var(--card); border-radius:16px; padding:16px; margin-bottom:20px;}
button{cursor:pointer; margin:2px;}
button.primary{background:linear-gradient(180deg,#2a9d8f,#238b7f); border:0; color:#fff; padding:6px 12px; border-radius:8px;}
button.ghost{background:#0f1116; color:var(--text); border:1px solid #2a2f3a; padding:6px 12px; border-radius:8px;}
input, select{padding:6px; border-radius:8px; border:1px solid #2a2f3a; background:#0f1116; color:var(--text);}
h2{margin-top:0;}
table{width:100%; border-collapse: collapse; margin-top:10px;}
th, td{padding:6px; border:1px solid #2a2f3a; text-align:left;}
video{width:100%; max-height:360px; border-radius:12px; background:#000;}
</style>
</head>
<body>
<div class="wrap">

<h1>QR Quiz Completo</h1>

<!-- Gerenciamento de Turmas -->
<div class="card">
<h2>Gerenciar Turmas</h2>
<input type="text" id="turmaName" placeholder="Nome da turma">
<button id="addTurmaBtn" class="primary">Adicionar Turma</button>
<select id="turmaSelect"></select>
</div>

<!-- Gerenciamento de Alunos -->
<div class="card">
<h2>Gerenciar Alunos</h2>
<input type="text" id="alunoName" placeholder="Nome do aluno">
<select id="alunoTurmaSelect"></select>
<button id="addAlunoBtn" class="primary">Adicionar Aluno</button>

<h3>Alunos cadastrados:</h3>
<table id="alunoTable">
<thead><tr><th>Nome</th><th>Turma</th><th>QR Code</th><th>Resposta</th><th>Ação</th></tr></thead>
<tbody></tbody>
</table>
</div>

<!-- Gerar QR Code -->
<div class="card">
<h2>Gerar QR Code</h2>
<select id="alunoQrSelect"></select>
<input type="text" id="qrText" placeholder="Conteúdo do QR (ex: Aluno-23)">
<button id="genQr" class="primary">Gerar QR</button>
<div id="qrOut"></div>
<button id="dlQr" class="ghost" disabled>Baixar PNG</button>
<button id="printQr" class="ghost" disabled>Imprimir</button>
<p>Use sempre o mesmo QR Code. A posição do QR determinará a alternativa A/B/C/D.</p>
</div>

<!-- Leitor de QR Code -->
<div class="card">
<h2>Leitor de QR Code</h2>
<button id="startBtn" class="primary">Iniciar Câmera</button>
<button id="stopBtn" class="ghost" disabled>Parar</button>
<label><input type="checkbox" id="mirrorToggle"> Espelhar</label>
<video id="video" autoplay muted playsinline></video>
<canvas id="canvas" style="display:none;"></canvas>
<div>
<p>Aluno: <span id="currentAluno">—</span></p>
<p>Alternativa escolhida: <span id="chosenAnswer">—</span></p>
</div>
</div>

</div>

<!-- Bibliotecas -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<script>
// ========== Dados e Persistência ==========
let data = JSON.parse(localStorage.getItem('qrQuizData') || '{"turmas":{}}');
const saveData = ()=>localStorage.setItem('qrQuizData', JSON.stringify(data));

// ========== Elementos ==========
const turmaName = document.getElementById('turmaName');
const addTurmaBtn = document.getElementById('addTurmaBtn');
const turmaSelect = document.getElementById('turmaSelect');

const alunoName = document.getElementById('alunoName');
const alunoTurmaSelect = document.getElementById('alunoTurmaSelect');
const addAlunoBtn = document.getElementById('addAlunoBtn');
const alunoTableBody = document.querySelector('#alunoTable tbody');

const alunoQrSelect = document.getElementById('alunoQrSelect');
const qrText = document.getElementById('qrText');
const genQr = document.getElementById('genQr');
const qrOut = document.getElementById('qrOut');
const dlQr = document.getElementById('dlQr');
const printQr = document.getElementById('printQr');

const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const mirrorToggle = document.getElementById('mirrorToggle');
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const currentAluno = document.getElementById('currentAluno');
const chosenAnswer = document.getElementById('chosenAnswer');

let stream = null, rafId = null;

// ========== Funções de atualização ==========
function updateTurmas(){
    turmaSelect.innerHTML='<option value="" disabled selected>Selecione turma</option>';
    alunoTurmaSelect.innerHTML='<option value="" disabled selected>Selecione turma</option>';
    alunoQrSelect.innerHTML='<option value="" disabled selected>Selecione aluno</option>';
    for(const t of Object.keys(data.turmas)){
        turmaSelect.appendChild(new Option(t,t));
        alunoTurmaSelect.appendChild(new Option(t,t));
        // alunos para QR select
        for(const a of Object.keys(data.turmas[t].alunos)){
            alunoQrSelect.appendChild(new Option(`${a} (${t})`, `${t}|${a}`));
        }
    }
}

function updateAlunos(){
    alunoTableBody.innerHTML='';
    for(const t of Object.keys(data.turmas)){
        for(const a of Object.keys(data.turmas[t].alunos)){
            const aluno = data.turmas[t].alunos[a];
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${a}</td>
                <td>${t}</td>
                <td>${aluno.qr || '—'}</td>
                <td>${aluno.resposta || '—'}</td>
                <td><button class="ghost" onclick="refazer('${t}','${a}')">Refazer</button></td>
            `;
            alunoTableBody.appendChild(tr);
        }
    }
}

// ========== Adicionar Turma ==========
addTurmaBtn.addEventListener('click',()=>{
    const nome = turmaName.value.trim();
    if(!nome){alert('Digite o nome da turma'); return;}
    if(data.turmas[nome]){alert('Turma já existe'); return;}
    data.turmas[nome] = {alunos:{}};
    saveData();
    updateTurmas();
    turmaName.value='';
});

// ========== Adicionar Aluno ==========
addAlunoBtn.addEventListener('click',()=>{
    const nome = alunoName.value.trim();
    const turma = alunoTurmaSelect.value;
    if(!nome || !turma){alert('Digite nome e selecione turma'); return;}
    if(data.turmas[turma].alunos[nome]){alert('Aluno já existe'); return;}
    data.turmas[turma].alunos[nome]={qr:'', resposta:null};
    saveData();
    updateTurmas();
    updateAlunos();
    alunoName.value='';
});

// ========== Refazer resposta ==========
function refazer(turma, aluno){
    data.turmas[turma].alunos[aluno].resposta = null;
    saveData();
    updateAlunos();
}

// ========== Gerar QR Code ==========
let qrInstance = null;
genQr.addEventListener('click',()=>{
    const val = qrText.value.trim();
    const sel = alunoQrSelect.value;
    if(!val || !sel){alert('Digite texto e selecione aluno'); return;}
    const [turma, aluno] = sel.split('|');
    qrOut.innerHTML='';
    qrInstance = new QRCode(qrOut, {text:val, width:240, height:240, correctLevel:QRCode.CorrectLevel.H});
    data.turmas[turma].alunos[aluno].qr = val;
    saveData();
    dlQr.disabled=false; printQr.disabled=false;
    updateAlunos();
});
dlQr.addEventListener('click',()=>{
    const img = qrOut.querySelector('img,canvas');
    if(!img) return;
    const dataURL = img.tagName==='IMG'?img.src:img.toDataURL();
    const a = document.createElement('a'); a.href=dataURL; a.download='qr.png'; a.click();
});
printQr.addEventListener('click',()=>{
    const img = qrOut.querySelector('img,canvas');
    if(!img) return;
    const w = window.open('','_blank'); w.document.write(`<img src="${img.src||img.toDataURL()}" style="width:380px;height:380px;">`); w.document.close(); w.focus(); w.print(); w.close();
});

// ========== Câmera e Leitura ==========
async function startCamera(){
    stopCamera();
    try{
        stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
        video.srcObject = stream;
        await video.play();
        canvas.width=video.videoWidth; canvas.height=video.videoHeight;
        scanLoop();
        startBtn.disabled=true; stopBtn.disabled=false;
    }catch(e){alert('Erro ao abrir câmera'); console.error(e);}
}
function stopCamera(){
    startBtn.disabled=false; stopBtn.disabled=true;
    if(rafId) cancelAnimationFrame(rafId);
    if(stream){stream.getTracks().forEach(t=>t.stop()); stream=null;}
}

function scanLoop(){
    if(!stream) return;
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
    const code = jsQR(imgData.data, imgData.width, imgData.height);
    if(code){
        const text = code.data;
        // procurar aluno pelo QR
        let found=false;
        for(const t of Object.keys(data.turmas)){
            for(const a of Object.keys(data.turmas[t].alunos)){
                if(data.turmas[t].alunos[a].qr===text){
                    currentAluno.textContent=a+' ('+t+')';
                    // detectar lado: 0°-A, 90°-B, 180°-C, 270°-D
                    const dx = code.location.topRightCorner.x - code.location.topLeftCorner.x;
                    const dy = code.location.topRightCorner.y - code.location.topLeftCorner.y;
                    let deg = Math.atan2(dy,dx)*180/Math.PI; if(deg<0) deg+=360;
                    const idx=Math.floor((deg+45)/90)%4;
                    const letras=['A','B','C','D'];
                    const l=letras[idx];
                    chosenAnswer.textContent=l;
                    // salvar apenas se ainda não respondeu
                    if(!data.turmas[t].alunos[a].resposta) data.turmas[t].alunos[a].resposta=l;
                    saveData();
                    updateAlunos();
                    found=true;
                }
            }
        }
        if(!found){currentAluno.textContent='Aluno não cadastrado'; chosenAnswer.textContent='—';}
    }
    rafId=requestAnimationFrame(scanLoop);
}

startBtn.addEventListener('click',startCamera);
stopBtn.addEventListener('click',stopCamera);

// ========== Inicialização ==========
updateTurmas();
updateAlunos();
</script>
</body>
</html>
